# Подробная инструкция по работе с админкой Splix

## Содержание

1. [Обзор системы](#обзор-системы)
2. [Подготовка к работе](#подготовка-к-работе)
3. [Доступ к админке](#доступ-к-админке)
4. [Управление игровыми серверами](#управление-игровыми-серверами)
5. [Как работают сервера](#как-работают-сервера)
6. [Создание нового сервера](#создание-нового-сервера)
7. [Настройка сервера](#настройка-сервера)
8. [Удаление сервера](#удаление-сервера)
9. [Автоматическое создание серверов](#автоматическое-создание-серверов)
10. [Troubleshooting](#troubleshooting)

---

## Обзор системы

Splix состоит из нескольких компонентов:

- **Game Server** (`gameServer/`) - основной игровой сервер, обрабатывающий игровую логику и WebSocket соединения игроков
- **Server Manager** (`serverManager/`) - система управления игровыми серверами, хранящая конфигурации и управляющая их жизненным циклом
- **Admin Panel** (`adminPanel/`) - веб-интерфейс для управления серверами через браузер
- **Client** (`client/`) - клиентская часть игры

### Архитектура

```
┌─────────────┐
│   Client    │ ──► Подключается к игровому серверу
└─────────────┘
      │
      ▼
┌─────────────────────────────────────┐
│      Production Server (8080)       │
│  ┌───────────────────────────────┐  │
│  │   Game Server Instance       │  │ ◄─── Игроки подключаются через WebSocket
│  │   (WebSocket: /gameserver)   │  │
│  └───────────────────────────────┘  │
│  ┌───────────────────────────────┐  │
│  │   Server Manager              │  │ ◄─── Админка подключается через WebSocket
│  │   (WebSocket: /servermanager) │  │
│  │   - Управление серверами      │  │
│  │   - Хранение конфигураций     │  │
│  │   - Мониторинг серверов       │  │
│  └───────────────────────────────┘  │
│  ┌───────────────────────────────┐  │
│  │   Admin Panel                 │  │ ◄─── Веб-интерфейс админки
│  │   (HTTP: /adminpanel/)        │  │
│  └───────────────────────────────┘  │
└─────────────────────────────────────┘
```

---

## Подготовка к работе

### 1. Сборка админки

Перед использованием админки необходимо собрать её:

```bash
cd /var/www/yourproject/apps/splix
deno task build-adminpanel
```

Это создаст собранные файлы в `adminPanel/out/dist/`.

### 2. Настройка переменных окружения

Создайте файл `.env` из шаблона:

```bash
cp env.example .env
```

Отредактируйте `.env` и обязательно установите безопасный токен:

```bash
# Генерация безопасного токена
export WEBSOCKET_AUTH_TOKEN=$(openssl rand -hex 32)

# Добавьте в .env:
WEBSOCKET_AUTH_TOKEN=ваш_сгенерированный_токен_здесь
PORT=8080
HOSTNAME=0.0.0.0
PROTOCOL=wss  # или ws если без SSL
DOMAIN=space-bot.ru
```

**⚠️ ВАЖНО:** Токен `WEBSOCKET_AUTH_TOKEN` используется для аутентификации в админке. Обязательно измените его на случайный безопасный токен перед запуском в production!

### 3. Запуск production сервера

```bash
deno task production
```

Или через systemd:

```bash
sudo systemctl start splix-production
```

---

## Доступ к админке

### URL админки

После запуска production сервера админка доступна по адресу:

```
http://yourdomain.com/adminpanel/
```

или

```
https://yourdomain.com/adminpanel/  (если настроен SSL)
```

### Аутентификация

При открытии админки происходит автоматическая аутентификация:

1. Админка запрашивает токен с `/servermanagerToken`
2. Устанавливается WebSocket соединение с `/servermanager`
3. Отправляется токен для аутентификации
4. При успешной аутентификации загружаются конфигурации всех серверов

Если аутентификация не удалась, вы увидите предупреждение в браузере.

---

## Управление игровыми серверами

### Интерфейс админки

Админка состоит из двух основных секций:

1. **Legacy Server Manager** - управление старыми серверами (legacy)
2. **Server Manager** - управление новыми игровыми серверами

### Основные элементы интерфейса

- **Кнопка "Create Game Server"** - создает новый игровой сервер
- **Карточки серверов** - отображают конфигурацию каждого сервера
- **Чекбоксы** - настройки сервера:
  - `Public` - сервер виден публично (в списке серверов для клиентов)
  - `Official` - официальный сервер
  - `Recommended` - рекомендуемый сервер
  - `Control socket` - использовать control socket для мониторинга
- **Поля ввода**:
  - `Display name` - отображаемое имя сервера
  - `Endpoint` - WebSocket URL сервера (например, `wss://space-bot.ru/gameserver`)
- **Кнопка "Delete"** - удаляет сервер

---

## Как работают сервера

### Типы серверов

В системе Splix есть два типа серверов:

1. **Встроенный Game Server** - единственный игровой сервер, который запускается вместе с production сервером. Он обрабатывает все игровые соединения через `/gameserver` endpoint.

2. **Внешние Game Servers** - серверы, которые могут быть запущены отдельно и подключены через админку. Они указываются через поле `Endpoint`.

### Как работает Server Manager

Server Manager (`serverManager/`) управляет конфигурациями игровых серверов:

1. **Хранение данных**: Конфигурации сохраняются в `serverManager/persistentStorage.json`
2. **Мониторинг**: Если включен `Control socket`, Server Manager устанавливает WebSocket соединение с игровым сервером для:
   - Получения количества игроков в реальном времени
   - Проверки доступности сервера
   - Получения данных лидерборда
3. **Публикация**: Только серверы с флагом `Public` и успешным подключением (если включен control socket) публикуются в `/servermanager/gameservers` для клиентов

### Control Socket

Control Socket - это специальное WebSocket соединение между Server Manager и Game Server:

- **Назначение**: Мониторинг состояния сервера, получение статистики
- **Когда используется**: Если в настройках сервера включен чекбокс `Control socket`
- **Что происходит**: Server Manager подключается к endpoint сервера и отправляет специальное сообщение инициализации
- **Результат**: Сервер отправляет обновления о количестве игроков и другой статистике

**Важно**: Если `Control socket` включен, но соединение не удается установить, сервер не будет показан в публичном списке серверов.

---

## Создание нового сервера

### Способ 1: Через админку (рекомендуется)

1. Откройте админку: `http://yourdomain.com/adminpanel/`
2. Нажмите кнопку **"Create Game Server"**
3. Новый сервер появится в списке с дефолтными настройками
4. Настройте сервер (см. раздел [Настройка сервера](#настройка-сервера))

### Способ 2: Автоматически при первом запуске

При первом запуске production сервера, если нет ни одного сервера, создается сервер автоматически с настройками:

```javascript
{
  public: true,
  official: true,
  recommended: true,
  needsControlSocket: false,
  displayName: "space-bot.ru Server",
  endpoint: "wss://space-bot.ru/gameserver"
}
```

Это происходит в `scripts/production.js` (строки 48-75).

### Способ 3: Через скрипт

Используйте скрипт `scripts/initProductionServer.js`:

```bash
export PROTOCOL="wss"  # или "ws" если без SSL
export DOMAIN="space-bot.ru"
export WEBSOCKET_AUTH_TOKEN="ваш_токен"
deno run -A scripts/initProductionServer.js
```

---

## Настройка сервера

### Параметры сервера

После создания сервера настройте его параметры:

#### Display Name
- **Описание**: Имя сервера, которое видят игроки
- **Пример**: `"Space-bot.ru Server"`, `"EU Server"`, `"US West"`

#### Endpoint
- **Описание**: WebSocket URL для подключения к серверу
- **Формат**: `ws://` или `wss://` + домен + путь
- **Примеры**:
  - `wss://space-bot.ru/gameserver` - для встроенного сервера
  - `wss://game1.example.com/ws` - для внешнего сервера
  - `ws://192.168.1.100:8080/gameserver` - для локального сервера

#### Public
- **Описание**: Делает сервер видимым в публичном списке серверов
- **Когда включать**: Если хотите, чтобы игроки могли видеть и подключаться к серверу
- **Когда выключать**: Для тестовых или приватных серверов

#### Official
- **Описание**: Помечает сервер как официальный
- **Использование**: Для серверов, которые вы официально поддерживаете

#### Recommended
- **Описание**: Помечает сервер как рекомендуемый
- **Использование**: Сервер будет выделен в списке для игроков

#### Control Socket
- **Описание**: Использовать control socket для мониторинга
- **Когда включать**: 
  - Если хотите видеть количество игроков в реальном времени
  - Если хотите, чтобы сервер автоматически скрывался при недоступности
- **Когда выключать**:
  - Для встроенного сервера (он всегда доступен)
  - Если внешний сервер не поддерживает control socket
  - Если возникают проблемы с подключением

### Сохранение настроек

Настройки сохраняются автоматически при изменении любого поля. Изменения отправляются на сервер через WebSocket и сохраняются в `persistentStorage.json`.

### Пример настройки для встроенного сервера

```
Display Name: Space-bot.ru Main Server
Endpoint: wss://space-bot.ru/gameserver
☑ Public
☑ Official
☑ Recommended
☐ Control socket  (можно выключить, т.к. сервер встроенный)
```

### Пример настройки для внешнего сервера

```
Display Name: EU Game Server
Endpoint: wss://eu-gameserver.example.com/ws
☑ Public
☑ Official
☐ Recommended
☑ Control socket  (включить для мониторинга)
```

---

## Удаление сервера

1. Найдите карточку сервера в админке
2. Нажмите кнопку **"Delete"**
3. Сервер будет удален из конфигурации и из `persistentStorage.json`

**⚠️ Внимание**: Удаление сервера не останавливает сам игровой сервер (если это внешний сервер). Оно только удаляет его из списка управляемых серверов.

---

## Автоматическое создание серверов

### При первом запуске

Production сервер автоматически создает сервер при первом запуске, если:

1. В `persistentStorage.json` нет сохраненных серверов
2. Список серверов пуст

Автоматически созданный сервер настраивается с параметрами из переменных окружения:
- `PROTOCOL` (по умолчанию `wss`)
- `DOMAIN` (по умолчанию `space-bot.ru`)

### Проверка автоматического создания

При запуске production сервера в логах вы увидите:

```
Initial servers check: 0 server(s) found
No game servers found. Creating default game server...
Server configs after creation: 1
Configuring server ID: 1 with endpoint: wss://space-bot.ru/gameserver
Servers after configuration: 1 server(s)
Server configured: {...}
```

---

## Troubleshooting

### Админка не открывается

**Проблема**: При открытии `/adminpanel/` видна ошибка 404 или "Admin panel not found"

**Решение**:
1. Убедитесь, что админка собрана: `deno task build-adminpanel`
2. Проверьте, что файлы существуют в `adminPanel/out/dist/`
3. Перезапустите production сервер

### Ошибка аутентификации

**Проблема**: В браузере появляется предупреждение "Failed to authenticate"

**Решение**:
1. Проверьте, что `WEBSOCKET_AUTH_TOKEN` в `.env` совпадает с тем, что используется сервером
2. Убедитесь, что токен не равен `change_me_in_production`
3. Перезапустите production сервер после изменения токена
4. Очистите кэш браузера и перезагрузите страницу

### Сервер не появляется в списке для клиентов

**Проблема**: Сервер создан и настроен, но не виден в `/servermanager/gameservers`

**Причины и решения**:

1. **Флаг `Public` не включен**
   - Включите чекбокс `Public` в админке

2. **Control Socket не подключен** (если включен)
   - Проверьте, что `Endpoint` правильный и доступен
   - Проверьте логи сервера на наличие ошибок подключения
   - Попробуйте временно отключить `Control socket` для теста

3. **Неправильный Endpoint**
   - Убедитесь, что URL правильный и доступен
   - Проверьте формат: должен начинаться с `ws://` или `wss://`

4. **Сервер не запущен** (для внешних серверов)
   - Убедитесь, что внешний игровой сервер запущен и доступен

### Изменения не сохраняются

**Проблема**: Изменения в админке не сохраняются

**Решение**:
1. Проверьте WebSocket соединение (откройте консоль разработчика в браузере)
2. Проверьте права на запись в `serverManager/persistentStorage.json`
3. Проверьте логи production сервера на наличие ошибок

### Control Socket не подключается

**Проблема**: Сервер с включенным `Control socket` не подключается

**Решение**:
1. Проверьте, что endpoint правильный и доступен
2. Убедитесь, что игровой сервер поддерживает control socket
3. Проверьте логи Server Manager на наличие ошибок подключения
4. Для встроенного сервера можно отключить `Control socket` - он все равно будет работать

### Проверка логов

Для просмотра логов production сервера:

```bash
# Если запущен через systemd
sudo journalctl -u splix-production -f

# Если запущен вручную
# Логи выводятся в консоль
```

### Проверка состояния серверов

Проверьте список серверов через API:

```bash
curl http://localhost:8080/servermanager/gameservers
```

Должен вернуться JSON с массивом `servers`.

### Проверка WebSocket соединения

В консоли браузера (F12) при открытии админки проверьте:

1. WebSocket соединение установлено
2. Нет ошибок в консоли
3. Сообщения отправляются и получаются

---

## Дополнительная информация

### Структура данных сервера

Конфигурация сервера хранится в формате:

```json
{
  "id": 1,
  "config": {
    "public": true,
    "official": true,
    "recommended": true,
    "needsControlSocket": false,
    "displayName": "Space-bot.ru Server",
    "endpoint": "wss://space-bot.ru/gameserver"
  }
}
```

### API Endpoints

- `GET /servermanager/gameservers` - список публичных серверов для клиентов
- `GET /servermanagerToken` - получение токена для админки
- `WebSocket /servermanager` - WebSocket для админки

### Файлы конфигурации

- `serverManager/persistentStorage.json` - хранилище конфигураций серверов
- `.env` - переменные окружения
- `nginx-space-bot.conf` - конфигурация Nginx (если используется)

---

## Безопасность

⚠️ **Важные рекомендации по безопасности:**

1. **Всегда меняйте `WEBSOCKET_AUTH_TOKEN`** на случайный безопасный токен перед запуском в production
2. **Не публикуйте токен** в публичных репозиториях или логах
3. **Используйте HTTPS/WSS** в production для защиты данных
4. **Ограничьте доступ** к админке через firewall или VPN при необходимости
5. **Регулярно проверяйте логи** на наличие подозрительной активности

---

## Полезные команды

```bash
# Сборка админки
deno task build-adminpanel

# Запуск production сервера
deno task production

# Проверка статуса (если через systemd)
sudo systemctl status splix-production

# Просмотр логов
sudo journalctl -u splix-production -f

# Перезапуск сервиса
sudo systemctl restart splix-production

# Проверка API серверов
curl http://localhost:8080/servermanager/gameservers
```

---

## Заключение

Админка Splix предоставляет удобный веб-интерфейс для управления игровыми серверами. Основные операции:

- ✅ Создание серверов через кнопку "Create Game Server"
- ✅ Настройка параметров через форму в карточке сервера
- ✅ Удаление серверов через кнопку "Delete"
- ✅ Автоматическое сохранение изменений
- ✅ Мониторинг состояния через Control Socket

При возникновении проблем проверяйте логи и убедитесь, что все компоненты правильно настроены и запущены.

